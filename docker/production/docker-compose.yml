version: "3.9"

services:
  speedtest:
    image: thekhoo/speedsnake:latest
    container_name: speedtest-service
    restart: unless-stopped

    # Uncomment to build locally instead of pulling from Docker Hub
    # build:
    #   context: ../..  # Project root
    #   dockerfile: docker/production/Dockerfile

    environment:
      SLEEP_SECONDS: ${SLEEP_SECONDS:-600}  # Default: 10 minutes
      # AWS bootstrap (required to assume role and access SSM)
      AWS_REGION: ${AWS_REGION:-eu-west-2}
      AWS_ROLE_ARN: ${AWS_ROLE_ARN}
      SSM_PATH_PREFIX: ${SSM_PATH_PREFIX}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}

    volumes:
      # Mount only data directories for persistence
      - speedtest-results:/app/results
      - speedtest-logs:/app/logs
      - speedtest-uploads:/app/uploads

    healthcheck:
      test: ["CMD", "python", "-c", "import pathlib; import sys; sys.exit(0 if pathlib.Path('/app/logs/speedtest.log').exists() else 1)"]
      interval: 5m
      timeout: 10s
      start_period: 30s
      retries: 3

volumes:
  speedtest-results:
    driver: local
  speedtest-logs:
    driver: local
  speedtest-uploads:
    driver: local
